@page "/messages"
@using CodeWash.MessageExchange.Dtos.QueryDtos
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject Services.UserService UserService
@inject Services.MessageService MessageService
@inject AuthenticationStateProvider AuthProvider

<MudGrid>
    <!-- Left Panel: User List -->
    <MudItem xs="12" sm="3" md="3" lg="2">
        <MudPaper Elevation="4" Class="pa-2" Style="height: 100vh; overflow-y: auto;">
            <MudText Typo="Typo.h6" Class="mb-2">Users</MudText>
            <MudList T="GetUsersExceptCurrentVM">
                @foreach (var user in _users)
                {
                    <MudListItem Class="user-list-item" @onclick="() => SelectUser(user)">
                        <MudText>@user.Email</MudText>
                    </MudListItem>
                }
            </MudList>
        </MudPaper>
    </MudItem>

    <!-- Right Panel: Chat Area -->
    <MudItem xs="12" sm="9" md="9" lg="10">
        <MudPaper Elevation="4" Class="pa-4">
            @if (_selectedRecipient != null)
            {
                <MudText Typo="Typo.h6">Chat with @_selectedRecipient.Email</MudText>
                <MudDivider Class="mb-3" />

                <!-- Messages List -->
                <MudList T="GetMessagesBetweenUsersVM" Style="height: 400px; overflow-y: auto;">
                    @foreach (var message in _messages)
                    {
                        <MudListItem Class="@GetMessageClass(message.SenderEmail)">
                            <MudText>@message.Content</MudText>
                            <MudText Typo="Typo.caption" Class="text-muted timestamp">
                                @message.Timestamp.ToString("HH:mm")
                            </MudText>
                        </MudListItem>
                    }
                </MudList>

                <!-- Message Input -->
                <MudTextField @bind-Value="_newMessage" Label="Type a message..." Adornment="Adornment.End" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SendMessage">
                    @(_messageIsSending ? "Sending..." : "Send")
                </MudButton>
            }
            else
            {
                <MudText Typo="Typo.subtitle1" Class="text-center">Select a user to start chatting</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private List<GetUsersExceptCurrentVM> _users = [];
    private GetUsersExceptCurrentVM? _selectedRecipient;
    private string _newMessage = string.Empty;
    private List<GetMessagesBetweenUsersVM> _messages = [];
    private bool _messagesIsLoading = false;
    private bool _messageIsSending = false;
    private string _currentUserEmail = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _users = await UserService.GetUsersExceptCurrentAsync();

        var authState = await AuthProvider.GetAuthenticationStateAsync();
        _currentUserEmail = authState.User.FindFirst(ClaimTypes.Email)?.Value ?? string.Empty;
    }

    private async Task SelectUser(GetUsersExceptCurrentVM user)
    {
        _selectedRecipient = user;
        await LoadMessagesForSelectedUser();
    }

    private async Task SendMessage()
    {
        _messageIsSending = true;

        try
        {
            if (!string.IsNullOrEmpty(_newMessage) && _selectedRecipient != null)
            {
                await MessageService.SendMessageAsync(_selectedRecipient.Email, _newMessage);
                _newMessage = string.Empty;
                await LoadMessagesForSelectedUser();
            }
        }
        finally
        {
            _messageIsSending = false;
        }
    }

    private async Task LoadMessagesForSelectedUser()
    {
        _messagesIsLoading = true;

        try
        {
            _messages.Clear();
            _messages = await MessageService.GetMessagesBetweenUsersAsync(_selectedRecipient!.Email);
        }
        finally
        {
            _messagesIsLoading = false;
        }
    }

    private string GetMessageClass(string senderEmail)
    {
        return "message-item " +
            (senderEmail == _currentUserEmail ? "sent-message" : "received-message");
    }
}

    <style>
    .message-item {
        max-width: 60%;
        padding: 10px;
        border-radius: 10px;
        margin: 5px;
        word-wrap: break-word;
    }

    .sent-message {
        background-color: #d4f8c6; /* Light green */
        align-self: flex-end;
        float: right;
        text-align: left; /* ✅ Fix: Align text left inside bubble */
    }

    .received-message {
        background-color: #ffffff; /* White */
        border: 1px solid #ccc;
        align-self: flex-start;
        float: left;
        text-align: left; /* ✅ Align text left for consistency */
    }
    </style>
